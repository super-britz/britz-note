## [雅虎军规](https://developer.yahoo.com/performance/rules.html?guccounter=1)

性能优化主要切入点可以从以下几个方面去考虑：

- 网络请求的全过程（从url地址栏输入发送请求开始到返回响应包的每个环节）
- 资源本身大小的压缩优化（想办法减少资源的体积）
- 浏览器渲染的全过程（拿到资源后浏览器渲染的每个环节）

> 使用 http 2，关于网络请求方面的很多规则都可以不考虑了，详细信息请移步
> [http 2](https://hpbn.co/optimizing-application-delivery/#optimizing-for-http2)

![Navigation Timing](../../../images/recorded_broadcast/week_fourth/yahoo.png)

##### 减少HTTP请求数

合并 js css image，使用 image base64 编码

##### 减少DNS查询

原则上减少DNS查找，同时也减少了页面能够并行下载的资源数量，
也可以通过 [DNS 预读取](https://developer.mozilla.org/zh-CN/docs/Controlling_DNS_prefetching)，减少用户点击链接时的延迟。

#####  避免重定向

重定向会影响用户体验

##### 缓存Ajax请求

Expires或者Cache-Control, 避免额外的 HTTP 往返消耗

##### 延迟加载

- 非首屏使用的数据、样式、脚本、图片等；
- 用户交互时才会显示的内容。

##### 预加载

预先加载利用浏览器空闲时间请求将来要使用的资源

- 无条件预先加载：页面加载完成（load）后，马上获取其他资源。
- 有条件预先加载：根据用户行为预判用户去向，预载相关资源。
- 有「阴谋」的预先加载：页面即将上线新版前预先加载新版内容。

##### 减少DOM元素数量

- 表格布局算法会产生大量重绘，标签多，无法适应响应式设计
- 处理布局，可以考虑语义化
- 能通过伪元素实现的功能，就没必要添加额外元素

##### 划分内容到不同域名

- 浏览器一般会限制每个域的并行线程（一般为6个），多域名可多并行线程下载
- 静态资源服务器可以禁用cookie，减少数据传输

##### 尽量减少iframe的使用

- 阻塞页面 load 事件触发
- 加载代价昂贵，即使是空的页面

##### 避免404错误

- 浪费服务器资源
- 阻塞其他资源下载，假如是外部脚本返回404，浏览器还会尝试把404页面内容当作JavaScript解析，消耗更多资源。

##### 使用CDN

减少中继路由跳转数

##### 添加Expires或Cache-Control响应头

- 静态内容：将 Expires 响应头设置为将来很远的时间，实现「永不过期」策略；
- 动态内容：设置合适的 Cache-Control 响应头，让浏览器有条件地发起请求。

###### 启用Gzip

压缩可以通过减少HTTP响应的大小来缩短响应时间

- Accept-Encoding 请求头
- Content-Encoding 响应头

##### 配置 Etag

- If-None-Match请求头来把 ETag 传回源服务器，响应 304 可以避免重新下载「响应体」

##### 尽早输出（flush）缓冲

用户请求页面时，服务器通常需要花费200 ~ 500毫秒来组合 HTML 页面。
强制将缓冲区中的数据发送出去，发送部分已经准备好的 HTML到浏览器，以便服务器还在忙于处理剩余页面时，浏览器可以提前开始获取资源。

- php 默认缓冲区 4k = 4096 Byte
- java 默认缓冲区 8k = 8192 Byte

##### Ajax 请求使用 GET 方法

GET用于获取数据，POST则用于向服务器发送数据。

- POST 请求时分成两步，先发送Http Header，再发送 data。
- GET只使用一个TCP数据包（Http Header与data）发送数据，所以首选 GET 方法。

##### 避免图片src为空

虽然src属性为空字符串，但浏览器仍然会向服务器发起一个HTTP请求。
> 空的 href 属性也存在类似问题

* 给服务器造成意外的流量负担，尤其时日 PV 较大时
* 浪费服务器计算资源
* 可能产生报错

##### 减少 Cookie 大小

Cookie被用于身份认证、个性化设置等诸多用途。Cookie通过HTTP头在服务器和浏览器间来回传送，减少Cookie大小可以降低其对响应速度的影响。

* 去除不必要的 Cookie；
* 尽量压缩 Cookie 大小；
* 注意设置 Cookie 的 domain 级别，如无必要，不要影响到 sub-domain；
* 设置合适的过期时间。

##### 静态资源使用无Cookie域名

静态资源一般无需使用Cookie，可以把它们放在使用二级域名或者专门域名的无Cookie服务器上，降低Cookie传送的造成的流量浪费，提高响应速度。

##### 把样式表放在`<head>`中

尽早呈现视觉反馈，给用户加载速度很快的感觉

##### 不要使用CSS表达式

CSS表达式超出预期的频繁执行，页面滚动、鼠标移动时都会不断执行，带来很大的性能损耗。

##### 使用`<link>`替代`@import`

对于IE某些版本，@import的行为和放在页面底部一样。

##### 不要使用 filter

AlphaImageLoader为IE5.5-IE8专有的技术，和CSS表达式一样，放进博物馆吧。IE专有的AlphaImageLoader滤镜可以用来修复IE7之前的版本中半透明PNG图片的问题。在图片加载过程中，这个滤镜会阻塞渲染，卡住浏览器，还会增加内存消耗而且是被应用到每个元素的，而不是每个图片，所以会存在一大堆问题。

> 这里所说的不是 CSS3 Filter

##### 把脚本放在页面底部

浏览器下载脚本时，会阻塞其他资源并行下载，即使是来自不同域名的资源。因此，最好将脚本放在底部，以提高页面加载速度。

##### 使用外部JavaScript和CSS

外部JavaScript和CSS文件可以被浏览器缓存，在不同页面间重用，也能降低页面大小。也可以预先加载子页面的资源。

##### 压缩JavaScript和CSS

压缩代码可以移除非功能性的字符（注释、空格、空行等），减少文件大小，提高载入速度。

##### 移除重复脚本

重复的脚本不仅产生不必要的HTTP请求，而且重复解析执行浪费时间和计算资源。

##### 减少DOM操作

- 避免使用JavaScript修复布局

##### 使用高效的事件处理

- 减少绑定事件监听的节点，如 react 通过事件委托；
- 尽早处理事件，在DOMContentLoaded即可进行，不用等到load以后。

##### 优化图片

- PNG 终极优化；
- Webp 相关内容；
- SVG 相关内容。

##### 优化CSS Sprite

- 雪碧图

##### 不要在HTML中缩放图片

不要使用 img 的width、height缩放图片，如果用到小图片，就使用相应大小的图片，很多 CMS 和 CDN 都提供图片裁切功能。

##### 使用体积小、可缓存的favicon.ico

Favicon.ico一般存放在网站根目录下，无论是否在页面中设置，浏览器都会尝试请求这个文件。

- 避免 404
- 尽量小，最好小于 1K；
- 设置较长的过期时间。

##### 保证所有组件都小于25K

这个限制是因为iPhone不能缓存大于25K的组件，注意这里指的是未压缩的大小。这就是为什么缩减内容本身也很重要，因为单纯的gzip可能不够。

##### 打包内容为分段（multipart）文档

把各个组件打包成一个像有附件的电子邮件一样的复合文档里，可以用一个HTTP请求获取多个组件